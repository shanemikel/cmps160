function init_range(args){let parse=args.parse;let update=args.update;let range=$('#'+args.id);let label=$('label[for='+args.id+']');range.off('change');range.off('input');range.attr('min',args.min);range.attr('max',args.max);range.attr('step',args.step);range.val(args.value);range.change(function(){label.text('('+parse(range.val())+')');if(update!==undefined)update();});range.on('input',function(){range.trigger('change');});range.trigger('change');range.prop('disabled',false);}
function init_color_picker(var_fn,picker_id,render_fn){let elem=$('#'+picker_id);elem.attr('value',var_fn().toHex());elem.on('input',function(e){var_fn(RGBColor.fromHex(e.target.value));render_fn();});}
function clear(gl,color){color=color?color.copy():(new RGBColor(0,0,0)).copy();gl.clearColor(color.r,color.g,color.b,color.a);gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);}
let render_flat=render_obj(flat_and_gouraud_shaders(),normalize_obj_flat);let render_gouraud=render_obj(flat_and_gouraud_shaders(),normalize_obj_average);let render_phong=render_obj(phong_shaders(),normalize_obj_average);function phong_shaders(){let vert=`#version 100
        attribute vec4 a_Position;
        attribute vec4 a_Normal;
        attribute vec4 a_Color;

        uniform mat4  u_Model;
        uniform mat4  u_View;
        uniform mat4  u_Projection;

        varying vec4  v_Position;
        varying vec4  v_Color;
        varying vec4  v_Normal;

        void main(void)
        {
            v_Position  = u_Model * a_Position;
            v_Position /= v_Position.w;
            v_Normal    = u_Model * a_Normal;
            v_Normal    = normalize(v_Normal);
            v_Color     = a_Color;

            gl_Position  = u_Projection * u_View * v_Position;
        }`;let frag=`#version 100
        precision mediump float;

        uniform vec3  u_AmbiantLightColor;

        uniform vec3  u_DirectLight;
        uniform vec3  u_DirectLightColor;

        uniform vec3  u_PointLight;
        uniform vec3  u_PointLightColor;
        uniform bool  u_PointLightOn;

        uniform vec3  u_CameraPosition;
        uniform float u_SpecularPower;

        varying vec4  v_Position;
        varying vec4  v_Color;
        varying vec4  v_Normal;

        void main(void)
        {
            vec3 directLight      = normalize(u_DirectLight);
            float directIntensity = max(dot(directLight, v_Normal.xyz), 0.0);

            vec3 pointDirection   = normalize(u_PointLight - v_Position.xyz);
            float pointIntensity  = max(dot(pointDirection, v_Normal.xyz), 0.0);

            vec3 viewDirection       = -normalize(u_CameraPosition - v_Position.xyz);
            vec3 reflectDirection    = reflect(pointDirection, v_Normal.xyz);
            float specularIntensity  = max(dot(viewDirection, reflectDirection), 0.0);

            vec3 light  = u_AmbiantLightColor;
            light      += directIntensity * u_DirectLightColor;

            if (u_PointLightOn)
                light  += pointIntensity * u_PointLightColor;

            if (u_SpecularPower >= 0.0)
                light  += pow(specularIntensity, u_SpecularPower) * u_PointLightColor;

            gl_FragColor = vec4(light * v_Color.rgb, v_Color.a);
        }    
    `;return{vert:vert,frag:frag};}
function flat_and_gouraud_shaders(){let vert=`#version 100
        attribute vec4 a_Position;
        attribute vec4 a_Normal;
        attribute vec4 a_Color;

        uniform mat4 u_Model;
        uniform mat4 u_View;
        uniform mat4 u_Projection;

        uniform vec3 u_AmbiantLightColor;

        uniform vec3 u_DirectLight;
        uniform vec3 u_DirectLightColor;

        uniform vec3 u_PointLight;
        uniform vec3 u_PointLightColor;
        uniform bool u_PointLightOn;

        uniform vec3  u_CameraPosition;
        uniform float u_SpecularPower;

        varying vec4 v_Color;

        void main(void)
        {
            gl_Position  = u_Model * a_Position;
            gl_Position /= gl_Position.w;
            vec4 normal  = u_Model * a_Normal;
            normal       = normalize(normal);

            vec3 directLight      = normalize(u_DirectLight);
            float directIntensity = max(dot(directLight, normal.xyz), 0.0);

            vec3 pointDirection  = normalize(u_PointLight - a_Position.xyz);
            float pointIntensity = max(dot(pointDirection, normal.xyz), 0.0);

            vec3 viewDirection      = -normalize(u_CameraPosition - gl_Position.xyz);
            vec3 reflectDirection   = reflect(pointDirection, normal.xyz);
            float specularIntensity = max(dot(viewDirection, reflectDirection), 0.0);

            vec3 light  = u_AmbiantLightColor;
            light      += directIntensity * u_DirectLightColor;

            if (u_PointLightOn)
                light  += pointIntensity * u_PointLightColor;

            if (u_SpecularPower >= 0.0)
                light  += pow(specularIntensity, u_SpecularPower) * u_PointLightColor;

            v_Color     = vec4(light * a_Color.rgb, a_Color.a);

            gl_Position = u_Projection * u_View * gl_Position;
        }`;let frag=`#version 100
        precision highp float;

        varying vec4 v_Color;

        void main(void)
        {
            gl_FragColor = v_Color;
        }    
    `;return{vert:vert,frag:frag};}
function render_obj(shaders,normalize_fn){return function(gl,obj,color,world,camera,projection,lights){let vert=shaders.vert;let frag=shaders.frag;if(!initShaders(gl,vert,frag)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let a_Normal=gl.getAttribLocation(gl.program,'a_Normal');if(a_Normal<0){console.log('Failed to get the storage location of '+'a_Normal');return;}
let a_Color=gl.getAttribLocation(gl.program,'a_Color');if(a_Color<0){console.log('Failed to get the storage location of '+'a_Color');return;}
let u_Model=gl.getUniformLocation(gl.program,'u_Model');if(!u_Model){console.log('Failed to get the storage location of '+'u_Model');return;}
let u_View=gl.getUniformLocation(gl.program,'u_View');if(!u_View){console.log('Failed to get the storage location of '+'u_View');return;}
let u_Projection=gl.getUniformLocation(gl.program,'u_Projection');if(!u_Projection){console.log('Failed to get the storage location of '+'u_Projection');return;}
let u_AmbiantLightColor=gl.getUniformLocation(gl.program,'u_AmbiantLightColor');if(!u_AmbiantLightColor){console.log('Failed to get the storage location of '+'u_AmbiantLightColor');return;}
let u_DirectLight=gl.getUniformLocation(gl.program,'u_DirectLight');if(!u_DirectLight){console.log('Failed to get the storage location of '+'u_DirectLight');return;}
let u_DirectLightColor=gl.getUniformLocation(gl.program,'u_DirectLightColor');if(!u_DirectLightColor){console.log('Failed to get the storage location of '+'u_DirectLightColor');return;}
let u_PointLight=gl.getUniformLocation(gl.program,'u_PointLight');if(!u_PointLight){console.log('Failed to get the storage location of '+'u_PointLight');return;}
let u_PointLightColor=gl.getUniformLocation(gl.program,'u_PointLightColor');if(!u_PointLightColor){console.log('Failed to get the storage location of '+'u_PointLightColor');return;}
let u_PointLightOn=gl.getUniformLocation(gl.program,'u_PointLightOn');if(!u_PointLightOn){console.log('Failed to get the storage location of '+'u_PointLightOn');return;}
let u_CameraPosition=gl.getUniformLocation(gl.program,'u_CameraPosition');if(!u_CameraPosition){console.log('Failed to get the storage location of '+'u_CameraPosition');return;}
let u_SpecularPower=gl.getUniformLocation(gl.program,'u_SpecularPower');if(!u_SpecularPower){console.log('Failed to get the storage location of '+'u_SpecularPower');return;}
light_xform=world;let ambiant_light;if(lights.ambiant!==null)
ambiant_light=lights.ambiant;else
ambiant_light=AmbiantLight.neutral();let al_col=ambiant_light.getColor();let direct_light;if(lights.direct!==null)
direct_light=lights.direct;else
direct_light=DirectLight.neutral();let dl_dir=light_xform.multiply(direct_light.getDirection());let dl_col=direct_light.getColor();let point_light;if(lights.point!==null)
point_light=lights.point;else
point_light=PointLight.neutral();let pl_pos=light_xform.multiply(point_light.getPosition());let pl_col=point_light.getColor();let pl_on=point_light.getOn();let specular_light;if(lights.specular!==null)
specular_light=lights.specular;else
specular_light=SpecularLight.neutral();let sl_pow=specular_light.getPower();gl.uniformMatrix4fv(u_Model,false,world.multiply(obj.getXForm()).flatten());gl.uniformMatrix4fv(u_View,false,camera.getView().flatten());gl.uniformMatrix4fv(u_Projection,false,projection.flatten());gl.uniform3f(u_AmbiantLightColor,al_col.r,al_col.g,al_col.b);gl.uniform3f(u_DirectLight,dl_dir.x,dl_dir.y,dl_dir.z);gl.uniform3f(u_DirectLightColor,dl_col.r,dl_col.g,dl_col.b);gl.uniform3f(u_PointLight,pl_pos.x,pl_pos.y,pl_pos.z);gl.uniform3f(u_PointLightColor,pl_col.r,pl_col.g,pl_col.b);gl.uniform1i(u_PointLightOn,pl_on);let cameraPos=camera.getEye();gl.uniform3f(u_CameraPosition,cameraPos.x,cameraPos.y,cameraPos.z);gl.uniform1f(u_SpecularPower,sl_pow);let count=obj.indices.length;obj=normalize_fn(obj);let vertices=Vector.flatten(obj.vertices);let normals=Vector.flatten(obj.normals);let buffer={vertices:gl.createBuffer(),normals:gl.createBuffer(),colors:gl.createBuffer()};if(!buffer.vertices||!buffer.normals||!buffer.colors){console.log('Failed to create the buffer objects');return;}
gl.bindBuffer(gl.ARRAY_BUFFER,buffer.vertices);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Position,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.normals);gl.bufferData(gl.ARRAY_BUFFER,normals,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Normal,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Normal);let colors=[];for(let i=0;i<count;i++)
colors.push(color.copy());colors=RGBColor.flatten(colors);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.colors);gl.bufferData(gl.ARRAY_BUFFER,colors,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Color,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Color);gl.drawArrays(gl.TRIANGLES,0,count);gl.disableVertexAttribArray(a_Color);gl.disableVertexAttribArray(a_Normal);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(buffer.colors);gl.deleteBuffer(buffer.normals);gl.deleteBuffer(buffer.vertices);}}
function normalize_obj_average(obj,args){args=$.extend({weighted:false},args);let face_map={data:{},insert_face_normal:function(i0,i1,i2,obj){let insert=function(that,index,obj){if(that.data[index]===undefined)
that.data[index]=[];that.data[index].push(obj);};insert(this,i0,obj);insert(this,i1,obj);insert(this,i2,obj);},lookup_incident_normals:function(i0){return this.data[i0];},};let count=obj.indices.length;for(let i=0;i<count/3;i++){let i0=obj.indices[3*i+0];let i1=obj.indices[3*i+1];let i2=obj.indices[3*i+2];let v0=obj.vertices[i0];let v1=obj.vertices[i1];let v2=obj.vertices[i2];let normal=v2.sub(v0).cross(v1.sub(v0));if(!args.weighted)
normal=normal.unit();face_map.insert_face_normal(i0,i1,i2,normal);}
let vertices=[];let normals=[];for(let i=0;i<count;i++){let i0=obj.indices[i];let v0=obj.vertices[i0];let normal=new Vector(0,0,0);let face_normals=face_map.lookup_incident_normals(i0);for(let j=0;j<face_normals.length;j++)
normal=normal.add(face_normals[j]);normal=normal.unit();normal.w=0;vertices.push(v0);normals.push(normal);}
return{vertices:vertices,normals:normals};}
function normalize_obj_flat(obj){let count=obj.indices.length;let vertices=[];let normals=[];for(let i=0;i<count/3;i++){let i0=obj.indices[3*i+0];let i1=obj.indices[3*i+1];let i2=obj.indices[3*i+2];let v0=obj.vertices[i0];let v1=obj.vertices[i1];let v2=obj.vertices[i2];let normal=v2.sub(v0).cross(v1.sub(v0)).unit();normal.w=0;vertices.push(v0);normals.push(normal);vertices.push(v1);normals.push(normal);vertices.push(v2);normals.push(normal);}
return{vertices:vertices,normals:normals};}
function render_normal(gl,obj,world,view,projection){let vert=`#version 100
        attribute vec4 a_Position;
        attribute vec4 a_Normal;

        uniform mat4 u_Model;
        uniform mat4 u_View;
        uniform mat4 u_Projection;

        varying vec4 v_Normal;

        void main(void)
        {
            v_Normal    = u_View * u_Model * a_Normal;
            gl_Position = u_Projection * u_View * u_Model * a_Position;
        }`;let frag=`#version 100
        precision mediump float;

        varying vec4 v_Normal;

        void main(void)
        {
            gl_FragColor = vec4(v_Normal.xyz, 1.0);
        }    
    `;if(!initShaders(gl,vert,frag)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let a_Normal=gl.getAttribLocation(gl.program,'a_Normal');if(a_Normal<0){console.log('Failed to get the storage location of '+'a_Normal');return;}
let u_Model=gl.getUniformLocation(gl.program,'u_Model');if(!u_Model){console.log('Failed to get the storage location of '+'u_Model');return;}
let u_View=gl.getUniformLocation(gl.program,'u_View');if(!u_View){console.log('Failed to get the storage location of '+'u_View');return;}
let u_Projection=gl.getUniformLocation(gl.program,'u_Projection');if(!u_Projection){console.log('Failed to get the storage location of '+'u_Projection');return;}
gl.uniformMatrix4fv(u_Model,false,world.multiply(obj.getXForm()).flatten());gl.uniformMatrix4fv(u_View,false,view.flatten());gl.uniformMatrix4fv(u_Projection,false,projection.flatten());let count=obj.indices.length;obj=normalize_obj_average(obj);let vertices=Vector.flatten(obj.vertices);let normals=Vector.flatten(obj.normals);let buffer={vertices:gl.createBuffer(),normals:gl.createBuffer()};if(!buffer.vertices||!buffer.normals){console.log('Failed to create the buffer objects');return;}
gl.bindBuffer(gl.ARRAY_BUFFER,buffer.vertices);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Position,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.normals);gl.bufferData(gl.ARRAY_BUFFER,normals,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Normal,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Normal);gl.drawArrays(gl.TRIANGLES,0,count);gl.disableVertexAttribArray(a_Normal);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(buffer.normals);gl.deleteBuffer(buffer.vertices);}
function render_depth(gl,obj,color,world,view,projection,rangeStart,rangeDepth){let vert=`#version 100
        attribute vec4 a_Position;

        uniform mat4 u_Model;
        uniform mat4 u_View;
        uniform mat4 u_Projection;

        varying float v_Depth;

        void main(void)
        {
            vec4 position = u_View * u_Model * a_Position;
            v_Depth       = -position.z;
            gl_Position   = u_Projection * position;
        }`;let frag=`#version 100
        precision mediump float;

        uniform vec3  u_Color;

        uniform float u_RangeStart;
        uniform float u_RangeDepth;

        varying float v_Depth;

        void main(void)
        {
            float colorScale = (v_Depth - u_RangeStart) / u_RangeDepth;
            colorScale       = 1.0 - max(0.0, min(colorScale, 1.0));
            gl_FragColor     = vec4(colorScale * u_Color, 1.0);
        }    
    `;if(!initShaders(gl,vert,frag)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let u_Model=gl.getUniformLocation(gl.program,'u_Model');if(!u_Model){console.log('Failed to get the storage location of '+'u_Model');return;}
let u_View=gl.getUniformLocation(gl.program,'u_View');if(!u_View){console.log('Failed to get the storage location of '+'u_View');return;}
let u_Projection=gl.getUniformLocation(gl.program,'u_Projection');if(!u_Projection){console.log('Failed to get the storage location of '+'u_Projection');return;}
let u_Color=gl.getUniformLocation(gl.program,'u_Color');if(!u_Color){console.log('Failed to get the storage location of '+'u_Color');return;}
let u_RangeStart=gl.getUniformLocation(gl.program,'u_RangeStart');if(!u_RangeStart){console.log('Failed to get the storage location of '+'u_RangeStart');return;}
let u_RangeDepth=gl.getUniformLocation(gl.program,'u_RangeDepth');if(!u_RangeDepth){console.log('Failed to get the storage location of '+'u_RangeDepth');return;}
gl.uniformMatrix4fv(u_Model,false,world.multiply(obj.getXForm()).flatten());gl.uniformMatrix4fv(u_View,false,view.flatten());gl.uniformMatrix4fv(u_Projection,false,projection.flatten());gl.uniform3f(u_Color,color.r,color.g,color.b);gl.uniform1f(u_RangeStart,rangeStart);gl.uniform1f(u_RangeDepth,rangeDepth);let indices=new Uint16Array(obj.indices);let count=indices.length;let vertices=Vector.flatten(obj.vertices);let buffer={indices:gl.createBuffer(),vertices:gl.createBuffer()};if(!buffer.indices||!buffer.vertices){console.log('Failed to create the buffer objects');return;}
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,buffer.indices);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,indices,gl.STREAM_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.vertices);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Position,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.drawElements(gl.TRIANGLES,count,gl.UNSIGNED_SHORT,0);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(buffer.normals);gl.deleteBuffer(buffer.vertices);}
function render_edge(gl,obj,color,edgeColor,exponent,world,view,projection){let vert=`#version 100
        attribute vec4 a_Position;
        attribute vec4 a_Normal;

        uniform mat4 u_Model;
        uniform mat4 u_View;
        uniform mat4 u_Projection;

        varying vec4 v_Position;
        varying vec4 v_Normal;

        void main(void)
        {
            v_Position  = u_View * u_Model * a_Position;
            v_Normal    = u_View * u_Model * a_Normal;
            gl_Position = u_Projection * v_Position;
        }`;let frag=`#version 100
        precision mediump float;

        uniform vec3  u_Color;
        uniform vec3  u_EdgeColor;
        uniform float u_Exponent;

        varying vec4 v_Position;
        varying vec4 v_Normal;

        void main(void)
        {
            float edgeFactor = dot(normalize(-v_Position.xyz), v_Normal.xyz);
            edgeFactor       = 1.0 - max(0.0, min(pow(edgeFactor, u_Exponent), 1.0));
            gl_FragColor     = vec4(edgeFactor * u_EdgeColor + u_Color, 1.0);
        }    
    `;if(!initShaders(gl,vert,frag)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let a_Normal=gl.getAttribLocation(gl.program,'a_Normal');if(a_Normal<0){console.log('Failed to get the storage location of '+'a_Normal');return;}
let u_Model=gl.getUniformLocation(gl.program,'u_Model');if(!u_Model){console.log('Failed to get the storage location of '+'u_Model');return;}
let u_View=gl.getUniformLocation(gl.program,'u_View');if(!u_View){console.log('Failed to get the storage location of '+'u_View');return;}
let u_Projection=gl.getUniformLocation(gl.program,'u_Projection');if(!u_Projection){console.log('Failed to get the storage location of '+'u_Projection');return;}
let u_Color=gl.getUniformLocation(gl.program,'u_Color');if(!u_Color){console.log('Failed to get the storage location of '+'u_Color');return;}
let u_EdgeColor=gl.getUniformLocation(gl.program,'u_EdgeColor');if(!u_EdgeColor){console.log('Failed to get the storage location of '+'u_EdgeColor');return;}
let u_Exponent=gl.getUniformLocation(gl.program,'u_Exponent');if(!u_Exponent){console.log('Failed to get the storage location of '+'u_Exponent');return;}
gl.uniformMatrix4fv(u_Model,false,world.multiply(obj.getXForm()).flatten());gl.uniformMatrix4fv(u_View,false,view.flatten());gl.uniformMatrix4fv(u_Projection,false,projection.flatten());gl.uniform3f(u_Color,color.r,color.g,color.b);gl.uniform3f(u_EdgeColor,edgeColor.r,edgeColor.g,edgeColor.b);gl.uniform1f(u_Exponent,exponent);let count=obj.indices.length;obj=normalize_obj_average(obj);let vertices=Vector.flatten(obj.vertices);let normals=Vector.flatten(obj.normals);let buffer={vertices:gl.createBuffer(),normals:gl.createBuffer()};if(!buffer.vertices||!buffer.normals){console.log('Failed to create the buffer objects');return;}
gl.bindBuffer(gl.ARRAY_BUFFER,buffer.vertices);gl.bufferData(gl.ARRAY_BUFFER,vertices,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Position,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.bindBuffer(gl.ARRAY_BUFFER,buffer.normals);gl.bufferData(gl.ARRAY_BUFFER,normals,gl.STREAM_DRAW);gl.vertexAttribPointer(a_Normal,4,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Normal);gl.drawArrays(gl.TRIANGLES,0,count);gl.disableVertexAttribArray(a_Normal);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(buffer.normals);gl.deleteBuffer(buffer.vertices);}
function render_grid(gl,color){let vertices=[];vertices.push([-1,0,0]);vertices.push([1,0,0]);vertices.push([0,-1,0]);vertices.push([0,1,0]);render_lines(gl,2,vertices,color);vertices=[];let tick_length=0.5;let tick_space=0.1;for(let i=1;i<=2/tick_space-1;i++){let tick=i*tick_space-1;vertices.push([-tick_length,tick,0]);vertices.push([tick_length,tick,0]);vertices.push([tick,-tick_length,0]);vertices.push([tick,tick_length,0]);}
render_lines(gl,1,vertices,color);}
function render_vertices(gl,mode,vertices,color){color=color?color.copy():WHITE.copy();let VSHADER=`
        attribute vec4 a_Position;
        uniform float u_PointSize;
        void main() {
            gl_Position = a_Position;
            gl_PointSize = u_PointSize;
        }
    `;let FSHADER=`
        precision mediump float;
        uniform vec4 u_FragColor;
        void main() {
            gl_FragColor = u_FragColor;
        }
    `;if(!initShaders(gl,VSHADER,FSHADER)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let u_FragColor=gl.getUniformLocation(gl.program,'u_FragColor');if(!u_FragColor){console.log('Failed to get the storage location of '+'u_FragColor');return;}
gl.uniform4f(u_FragColor,color.r,color.g,color.b,color.a);let vertexBuffer=gl.createBuffer();if(!vertexBuffer){console.log('Failed to create the buffer object');return;}
let buffer=flattenF32(3,vertices);let count=vertices.length;gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,buffer,gl.DYNAMIC_DRAW);gl.vertexAttribPointer(a_Position,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.drawArrays(mode,0,count);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(vertexBuffer);}
function render_lines(gl,width,vertices,color){gl.lineWidth(width);render_vertices(gl,gl.LINES,vertices,color);}
function render_line_strip(gl,width,vertices,color){gl.lineWidth(width);render_vertices(gl,gl.LINE_STRIP,vertices,color);}
function render_line_loop(gl,width,vertices,color){gl.lineWidth(width);render_vertices(gl,gl.LINE_LOOP,vertices,color);}
function render_triangles(gl,vertices,color){render_vertices(gl,gl.TRIANGLES,vertices,color);}
function render_triangle_strip(gl,vertices,color){render_vertices(gl,gl.TRIANGLE_STRIP,vertices,color);}
function render_triangle_fan(gl,vertices,color){render_vertices(gl,gl.TRIANGLE_FAN,vertices,color);}
function render_points(gl,point_size,vertices,color){color=color?color.copy():WHITE.copy();let VSHADER=`
        attribute vec4 a_Position;
        uniform float u_PointSize;
        void main() {
            gl_Position = a_Position;
            gl_PointSize = u_PointSize;
        }
    `;let FSHADER=`
        precision mediump float;
        uniform vec4 u_FragColor;
        void main() {
            gl_FragColor = u_FragColor;
        }
    `;if(!initShaders(gl,VSHADER,FSHADER)){console.log('Failed to intialize shaders.');return;}
let a_Position=gl.getAttribLocation(gl.program,'a_Position');if(a_Position<0){console.log('Failed to get the storage location of '+'a_Position');return;}
let u_FragColor=gl.getUniformLocation(gl.program,'u_FragColor');if(!u_FragColor){console.log('Failed to get the storage location of '+'u_FragColor');return;}
let u_PointSize=gl.getUniformLocation(gl.program,'u_PointSize');if(!u_PointSize){console.log('Failed to get the storage location of '+'u_PointSize');return;}
gl.uniform1f(u_PointSize,point_size);gl.uniform4f(u_FragColor,color.r,color.g,color.b,color.a);let vertexBuffer=gl.createBuffer();if(!vertexBuffer){console.log('Failed to create the buffer object');return;}
let buffer=flattenF32(3,vertices);let count=vertices.length;gl.bindBuffer(gl.ARRAY_BUFFER,vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,buffer,gl.DYNAMIC_DRAW);gl.vertexAttribPointer(a_Position,3,gl.FLOAT,false,0,0);gl.enableVertexAttribArray(a_Position);gl.drawArrays(gl.POINTS,0,count);gl.disableVertexAttribArray(a_Position);gl.deleteBuffer(vertexBuffer);}
function get_mouse_xy(canvas,ev){let x=ev.clientX;let y=ev.clientY;let rect=ev.target.getBoundingClientRect();if(rect.left<=x&&x<rect.right&&rect.top<=y&&y<rect.bottom)
return{x:x-rect.left,y:rect.bottom-y};}
function flattenF32(n,arr){let res=new Float32Array(arr.length*n);for(let i=0;i<arr.length;i++){for(let j=0;j<n;j++)
res[n*i+j]=arr[i][j];}
return res;}
function sleep(time){return new Promise((resolve)=>setTimeout(resolve,time));}
let Polyline=function(color){this.color=color?color.copy():WHITE.copy();this.points=[];};Polyline.prototype={addPoint:function(x,y){this.points.push(new Vector(x,y,0));},getPoints:function(mouseXY){let res=[];for(let i=0;i<this.points.length;i++)
res.push(this.points[i].copy());if(mouseXY!==undefined)
res.push(new Vector(mouseXY[0],mouseXY[1],0));return res;},setColor:function(color){this.color=color.copy();},getColor:function(){return this.color.copy();},};let Cube=function(center,sideLength){this.center=center;this.side=sideLength;};Cube.prototype={getCenter:function(){return this.center.copy();},setCenter:function(center){this.center=center.copy();},getSideLength:function(){return this.side;},setSideLength:function(sideLength){this.side=sideLength;},toSquares:function(){let res=[];let delte=this.side/2;let center=this.center;res.push(center.plus(new Vector(-delta,-delta,-delta)));res.push(center.plus(new Vector(-delta,-delta,delta)));res.push(center.plus(new Vector(-delta,delta,-delta)));res.push(center.plus(new Vector(-delta,delta,delta)));res.push(center.plus(new Vector(delta,-delta,-delta)));res.push(center.plus(new Vector(delta,-delta,delta)));res.push(center.plus(new Vector(delta,delta,-delta)));res.push(center.plus(new Vector(delta,delta,delta)));return res;},toTriangles:function(){let obj={vertices:this.toSquares(),indices:[]};},};let Circle=function(center,radius){this.center=center.copy();this.radius=radius;};Circle.prototype={getCenter:function(){return this.center.copy();},setCenter:function(center){this.center=center.copy();},getRadius:function(){return this.radius;},setRadius:function(radius){this.radius=radius;},toPolygon:function(sides){let sliceAngle=2*Math.PI/sides;let res=[];for(let i=0;i<sides;i++){let x,y;if(sides%2==0){x=this.radius*Math.cos(i*sliceAngle);y=this.radius*Math.sin(i*sliceAngle);}else{y=this.radius*Math.cos(i*sliceAngle);x=this.radius*Math.sin(i*sliceAngle);}
res[i]=new Vector(this.center.x+x,this.center.y+y,this.center.z);}
return res;},toWireframe:function(sides){let obj={vertices:[this.center.copy()].concat(this.toPolygon(sides)),indices:[],};for(let i=1;i<obj.vertices.length;i++){let i2=i+1;if(i2==obj.vertices.length)
i2=1;obj.indices.push(0);obj.indices.push(i);obj.indices.push(i);obj.indices.push(i2);}
return obj;},toTriangles:function(sides){let obj={vertices:[this.center.copy()].concat(this.toPolygon(sides)),indices:[],};for(let i=1;i<obj.vertices.length;i++){let i2=i+1;if(i2==obj.vertices.length)
i2=1;obj.indices.push(0);obj.indices.push(i);obj.indices.push(i2);}
return obj;},};let Sphere=function(center,radius){this.center=center.copy();this.radius=radius;};Sphere.prototype={toPolygons:function(polygon_count,polygon_side_count){let polygons=[];let delta_phi=Math.PI/polygon_count;let delta_theta=2*Math.PI/polygon_side_count;for(let i=0;i<polygon_count;i++){polygons.push([]);let polygon=polygons[polygons.length-1];let phi=i*delta_phi+delta_phi/2;for(let j=0;j<polygon_side_count;j++){let theta=j*delta_theta;let x=this.radius*Math.sin(phi)*Math.cos(theta);let y=this.radius*Math.sin(phi)*Math.sin(theta);let z=this.radius*Math.cos(phi);x+=this.center.x;y+=this.center.y;z+=this.center.z;polygon.push(new Vector(x,y,z));}}
return polygons;},toTriangles:function(polygon_count,polygon_side_count){let obj={indices:[],vertices:[]};let polygons=this.toPolygons(polygon_count,polygon_side_count);let start=1;let top=0;for(let i=0;i<polygon_side_count;i++){let i2=(i+1)%polygon_side_count;let j=i+start;let j2=i2+start;obj.indices.push(top);obj.indices.push(j2);obj.indices.push(j);}
let top_vertex=new Vector(this.center.x,this.center.y,this.center.z+this.radius);let top_polygon=polygons[0];obj.vertices.push(top_vertex);obj.vertices=obj.vertices.concat(top_polygon);for(let i=0;i<polygon_count-1;i++){start=1;if(i>0)
start=obj.vertices.length;let start_next=start+polygon_side_count;for(let j=0;j<polygon_side_count;j++){let j2=(j+1)%polygon_side_count;let k=j+start;let k2=j2+start;let l=j+start_next;let l2=j2+start_next;obj.indices.push(l);obj.indices.push(k);obj.indices.push(k2);obj.indices.push(l);obj.indices.push(k2);obj.indices.push(l2);}
if(i>0){let polygon=polygons[i];obj.vertices=obj.vertices.concat(polygon);}}
start=obj.vertices.length;let bottom=start+polygon_side_count;for(let i=0;i<polygon_side_count;i++){let i2=(i+1)%polygon_side_count;let j=i+start;let j2=i2+start;obj.indices.push(bottom);obj.indices.push(j);obj.indices.push(j2);}
let bottom_vertex=new Vector(this.center.x,this.center.y,this.center.z-this.radius);let bottom_polygon=polygons[polygons.length-1];obj.vertices=obj.vertices.concat(bottom_polygon);obj.vertices.push(bottom_vertex);return obj;},};let Cylinder=function(end1,end2,radius,color){this.end1=end1.copy();this.end2=end2.copy();end1.z=0;end2.z=0;this.radius=radius;if(color!==undefined)
this.color=color.copy();else
this.color=WHITE.copy();};Cylinder.prototype={getColor:function(){return this.color.copy();},setColor:function(color){this.color=color.copy();},getRadius:function(){return this.radius;},setRadius:function(radius){this.radius=radius;},bridgeFrameIndices:function(sides){let indices=[];for(let i=1;i<sides+1;i++){let i2=i+1;if(i2==sides+1)
i2=1;indices.push({end:1,index:i});indices.push({end:2,index:i});indices.push({end:2,index:i});indices.push({end:1,index:i2});}
return indices;},bridgeTrigsIndices:function(sides){let indices=[];for(let i=1;i<sides+1;i++){let i2=i+1;if(i2==sides+1)
i2=1;if(sides%2==1){indices.push({end:1,index:i});indices.push({end:2,index:i});indices.push({end:1,index:i2});indices.push({end:1,index:i2});indices.push({end:2,index:i});indices.push({end:2,index:i2});}else{indices.push({end:2,index:i});indices.push({end:1,index:i});indices.push({end:1,index:i2});indices.push({end:2,index:i});indices.push({end:1,index:i2});indices.push({end:2,index:i2});}}
return indices;},toObj:function(circleObjFn,bridgeIndicesFn,sides){let obj={vertices:[],indices:[]};let c1_obj=new Circle((new Vector(0,0,0)),this.radius)[circleObjFn](sides);let c2_obj=new Circle((new Vector(0,0,0)),this.radius)[circleObjFn](sides);let c1_start=0;let c2_start=c1_obj.vertices.length;if(sides%2==1){obj.indices=obj.indices.concat(c1_obj.indices);for(let i=0;i<c2_obj.indices.length/3;i++){let tmp=c2_obj.indices[3*i+1];c2_obj.indices[3*i+1]=c2_obj.indices[3*i+2]
c2_obj.indices[3*i+2]=tmp;}
obj.indices=obj.indices.concat(c2_obj.indices.map(i=>i+c2_start));}else{for(let i=0;i<c1_obj.indices.length/3;i++){let tmp=c1_obj.indices[3*i+1];c1_obj.indices[3*i+1]=c1_obj.indices[3*i+2]
c1_obj.indices[3*i+2]=tmp;}
obj.indices=obj.indices.concat(c1_obj.indices);obj.indices=obj.indices.concat(c2_obj.indices.map(i=>i+c2_start));}
{let indices=this[bridgeIndicesFn](sides).map(function(i){switch(i.end){case 1:return i.index+c1_start;break;case 2:return i.index+c2_start;break;}});obj.indices=obj.indices.concat(indices);}
let dir=this.end2.sub(this.end1).unit();let id=new Matrix();let rotZ=id.rotateZ(-Math.atan(dir.y/dir.x));let c1_vertices,c2_vertices;{let m_rot=rotZ.multiply(id.rotateY(Radians.fromDegrees(90)));let xform1=v=>m_rot.translate(this.end1).multiply(v);c1_vertices=c1_obj.vertices.map(xform1);}
{let m_rot=rotZ.multiply(id.rotateY(Radians.fromDegrees(90)));let xform2=v=>m_rot.translate(this.end2).multiply(v);c2_vertices=c2_obj.vertices.map(xform2);}
obj.vertices=obj.vertices.concat(c1_vertices);obj.vertices=obj.vertices.concat(c2_vertices);return obj;},toWireframe:function(sides){return this.toObj('toWireframe','bridgeFrameIndices',sides);},toTriangles:function(sides){return this.toObj('toTriangles','bridgeTrigsIndices',sides);},};let Model=function(name,indices,vertices,args){args=$.extend({color:WHITE,show:true},args);this.name=name.slice();this.indices=indices.slice();this.vertices=vertices.slice();this.rotateX=0;this.rotateY=0;this.rotateZ=0;this.translateX=0;this.translateY=0;this.translateZ=0;this.scaleX=1;this.scaleY=1;this.scaleZ=1;this.color=args.color.copy();this.isVisible=args.show;};Model.prototype={getName:function(){return this.name.slice();},visible:function(show){if(show!==undefined)
this.isVisible=show;return this.isVisible;},getRotateX:function(){return this.rotateX;},setRotateX:function(rotateX){this.rotateX=rotateX;},getRotateY:function(){return this.rotateY;},setRotateY:function(rotateY){this.rotateY=rotateY;},getRotateZ:function(){return this.rotateZ;},setRotateZ:function(rotateZ){this.rotateZ=rotateZ;},getTranslateX:function(){return this.translateX;},setTranslateX:function(translateX){this.translateX=translateX;},getTranslateY:function(){return this.translateY;},setTranslateY:function(translateY){this.translateY=translateY;},getTranslateZ:function(){return this.translateZ;},setTranslateZ:function(translateZ){this.translateZ=translateZ;},getScaleX:function(){return this.scaleX;},setScaleX:function(scaleX){this.scaleX=scaleX;},getScaleY:function(){return this.scaleY;},setScaleY:function(scaleY){this.scaleY=scaleY;},getScaleZ:function(){return this.scaleZ;},setScaleZ:function(scaleZ){this.scaleZ=scaleZ;},getXForm:function(){let xform=new Matrix();xform=xform.rotateX(this.rotateX);xform=xform.rotateY(this.rotateY);xform=xform.rotateZ(this.rotateZ);let scaleVec=new Vector(this.scaleX,this.scaleY,this.scaleZ);xform=xform.scale(scaleVec);let translateVec=new Vector(this.translateX,this.translateY,this.translateZ);xform=xform.translate(translateVec);return xform;},getColor:function(){return this.color;},setColor:function(color){this.color=color.copy();},toSOR:function(){let xform=this.getXForm();let vertices=this.vertices.map(v=>xform.multiply(v));return new SOR(this.name.slice(),vertices,this.indices.slice());},};Model.fromSOR=function(objSOR){return new Model(objSOR.objName,objSOR.indexes,objSOR.vertices);};let Vector=function(x,y,z,w){this.x=x;this.y=y;this.z=z!==undefined?z:0;this.w=w!==undefined?w:1;};Vector.prototype={negate:function(){return new Vector(-this.x,-this.y,-this.z,this.w);},magnitude:function(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)+Math.pow(this.z,2));},unit:function(){let len=this.magnitude();if(len==0)
return(new Vector(0,0,0));return new Vector(this.x/len,this.y/len,this.z/len);},scale:function(scalar){return new Vector(scalar*this.x,scalar*this.y,scalar*this.z);},add:function(that){return new Vector(this.x+that.x,this.y+that.y,this.z+that.z);},sub:function(that){return new Vector(this.x-that.x,this.y-that.y,this.z-that.z);},dot:function(that){return this.x*that.x+this.y*that.y+this.z*that.z;},cross:function(that){return new Vector(this.y*that.z-this.z*that.y,this.z*that.x-this.x*that.z,this.x*that.y-this.y*that.x);},rotate:function(vector,radians){let xform=(new Matrix()).rotate(this,radians);return xform.multiply(vector);},toList:function(){return[this.x,this.y,this.z,this.w];},copy:function(){return new Vector(this.x,this.y,this.z,this.w);},};Vector.flatten=function(arr){let res=new Float32Array(arr.length*4);for(let i=0;i<arr.length;i++){res[4*i+0]=arr[i].x;res[4*i+1]=arr[i].y;res[4*i+2]=arr[i].z;res[4*i+3]=arr[i].w;}
return res;};let Matrix=function(){this.data=new Float32Array(4*4);for(let i=0;i<4;i++)
this.data[4*i+i]=1;};Matrix.prototype={scale:function(value){if(typeof value==='number'){return this.scale(new Vector(value,value,value));}else{let mat=new Matrix();mat.data[4*0+0]=value.x;mat.data[4*1+1]=value.y;mat.data[4*2+2]=value.z;return mat.multiply(this);}},translate:function(vector){let mat=new Matrix();mat.data[4*0+3]=vector.x;mat.data[4*1+3]=vector.y;mat.data[4*2+3]=vector.z;return mat.multiply(this);},rotateX:function(radians){let mat=new Matrix();let row=0;mat.data[4*row+0]=1;mat.data[4*row+1]=0;mat.data[4*row+2]=0;row=1;mat.data[4*row+0]=0;mat.data[4*row+1]=Math.cos(radians);mat.data[4*row+2]=Math.sin(radians);row=2;mat.data[4*row+0]=0;mat.data[4*row+1]=-Math.sin(radians);mat.data[4*row+2]=Math.cos(radians);return mat.multiply(this);},rotateY:function(radians){let mat=new Matrix();let row=0;mat.data[4*row+0]=Math.cos(radians);mat.data[4*row+1]=0;mat.data[4*row+2]=-Math.sin(radians);row=1;mat.data[4*row+0]=0;mat.data[4*row+1]=1;mat.data[4*row+2]=0;row=2;mat.data[4*row+0]=Math.sin(radians);mat.data[4*row+1]=0;mat.data[4*row+2]=Math.cos(radians);return mat.multiply(this);},rotateZ:function(radians){let mat=new Matrix();let row=0;mat.data[4*row+0]=Math.cos(radians);mat.data[4*row+1]=Math.sin(radians);mat.data[4*row+2]=0;row=1;mat.data[4*row+0]=-Math.sin(radians);mat.data[4*row+1]=Math.cos(radians);mat.data[4*row+2]=0;row=2;mat.data[4*row+0]=0;mat.data[4*row+1]=0;mat.data[4*row+2]=1;return mat.multiply(this);},rotate:function(vector,radians){let mat=new Matrix();let axis=vector.unit();let x=axis.x;let y=axis.y;let z=axis.z;let o=radians;let row=0;mat.data[4*row+0]=Math.cos(o)+Math.pow(x,2)*(1-Math.cos(o));mat.data[4*row+1]=x*y*(1-Math.cos(o))-z*Math.sin(o);mat.data[4*row+2]=x*z*(1-Math.cos(o))+y*Math.sin(o);row=1;mat.data[4*row+0]=y*x*(1-Math.cos(o))+z*Math.sin(o);mat.data[4*row+1]=Math.cos(o)+Math.pow(y,2)*(1-Math.cos(o));mat.data[4*row+2]=y*z*(1-Math.cos(o))-x*Math.sin(o);row=2;mat.data[4*row+0]=z*x*(1-Math.cos(o))-y*Math.sin(o);mat.data[4*row+1]=z*y*(1-Math.cos(o))+x*Math.sin(o);mat.data[4*row+2]=Math.cos(o)+Math.pow(z,2)*(1-Math.cos(o));return mat.multiply(this);},multiply:function(other){if(other.data===undefined){other=[other.x,other.y,other.z,other.w];let vec=[0,0,0,0];for(let i=0;i<4;i++){for(let k=0;k<4;k++){let lhs=this.data[4*i+k];vec[i]+=lhs*other[k];}}
return new Vector(vec[0],vec[1],vec[2],vec[3]);}else{let mat=new Matrix();mat.data=new Float32Array(4*4);for(let i=0;i<4;i++){for(let j=0;j<4;j++){for(let k=0;k<4;k++){let lhs=this.data[4*i+k];let rhs=other.data[4*k+j];mat.data[4*i+j]+=lhs*rhs;}}}
return mat;}},transpose:function(){let mat=new Matrix();for(let i=0;i<4;i++){for(let j=0;j<4;j++){mat.data[4*i+j]=this.data[4*j+i];mat.data[4*j+i]=this.data[4*i+j];}}
return mat;},flatten:function(){return this.transpose().data;},};Matrix.lookAt=function(args){let f=args.at.sub(args.eye).unit();let s=f.cross(args.up.unit());let u=s.cross(f);let t=args.eye.negate();let mat=new Matrix();let row=0;mat.data[4*row+0]=s.x;mat.data[4*row+1]=s.y;mat.data[4*row+2]=s.z;mat.data[4*row+3]=s.dot(t);row=1;mat.data[4*row+0]=u.x;mat.data[4*row+1]=u.y;mat.data[4*row+2]=u.z;mat.data[4*row+3]=u.dot(t);row=2;mat.data[4*row+0]=-f.x;mat.data[4*row+1]=-f.y;mat.data[4*row+2]=-f.z;mat.data[4*row+3]=-f.dot(t);return mat;};Matrix.ortho=function(args){let left=args.left;let right=args.right;let bottom=args.bottom;let top=args.top;let near=args.near;let far=args.far;let mat=new Matrix();let row=0;mat.data[4*row+0]=2/(right-left);mat.data[4*row+1]=0;mat.data[4*row+2]=0;mat.data[4*row+3]=-(right+left)/(right-left);row=1;mat.data[4*row+0]=0;mat.data[4*row+1]=2/(top-bottom);mat.data[4*row+2]=0;mat.data[4*row+3]=-(top+bottom)/(top-bottom);row=2;mat.data[4*row+0]=0;mat.data[4*row+1]=0;mat.data[4*row+2]=-2/(far-near);mat.data[4*row+3]=-(far+near)/(far-near);return mat;};Matrix.perspective=function(args){let fovy=args.fovy;let aspect=args.aspect;let near=args.near;let far=args.far;let mat=new Matrix();let row=0;mat.data[4*row+0]=1/(Math.tan(fovy/2)*aspect);mat.data[4*row+1]=0;mat.data[4*row+2]=0;mat.data[4*row+3]=0;row=1;mat.data[4*row+0]=0;mat.data[4*row+1]=1/Math.tan(fovy/2);mat.data[4*row+2]=0;mat.data[4*row+3]=0;row=2;mat.data[4*row+0]=0;mat.data[4*row+1]=0;mat.data[4*row+2]=-(far+near)/(far-near);mat.data[4*row+3]=-(2*far*near)/(far-near);row=3;mat.data[4*row+0]=0;mat.data[4*row+1]=0;mat.data[4*row+2]=-1;mat.data[4*row+3]=0;return mat;};let Radians={fromDegrees:function(degrees){return degrees*Math.PI/180;},};let RGBColor=function(r,g,b,a){this.r=r;this.g=g;this.b=b;this.a=a!==undefined?a:1;};RGBColor.prototype={scale:function(scalar){return new RGBColor(this.r*scalar,this.g*scalar,this.b*scalar,this.a);},setAlpha:function(alpha){this.a=alpha;return this;},toList:function(){return[this.r,this.g,this.b,this.a];},toHex:function(){let hexValue=function(number){return Math.floor(number*255).toString(16);};return '#'+hexValue(this.r)+hexValue(this.g)+hexValue(this.b);},copy:function(){return new RGBColor(this.r,this.g,this.b,this.a);},};RGBColor.fromHex=function(hex){let hexToRgb=function(hex){let result=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return result?{r:parseInt(result[1],16),g:parseInt(result[2],16),b:parseInt(result[3],16)}:null;};let rgb=hexToRgb(hex.trim());rgb=new RGBColor(rgb.r/255,rgb.g/255,rgb.b/255);return rgb;};RGBColor.flatten=function(arr){let res=new Float32Array(arr.length*4);for(let i=0;i<arr.length;i++){res[4*i+0]=arr[i].r;res[4*i+1]=arr[i].g;res[4*i+2]=arr[i].b;res[4*i+3]=arr[i].a;}
return res;};let AmbiantLight=function(color){this.color=color.copy();};AmbiantLight.prototype={getColor:function(){return this.color.copy();},setColor:function(color){this.color=color.copy();},copy:function(){return new AmbiantLight(this.color.copy());},};AmbiantLight.neutral=function(){return new AmbiantLight((new RGBColor(0,0,0)));};let DirectLight=function(direction,color){this.direction=direction.unit();this.direction.w=0;this.color=color.copy();};DirectLight.prototype={getDirection:function(){return this.direction.negate();},setDirection:function(direction){this.direction=direction.unit();this.direction.w=0;},getColor:function(){return this.color.copy();},setColor:function(color){this.color=color.copy();},copy:function(){return new DirectLight(this.direction.copy(),this.color.copy());},};DirectLight.neutral=function(){return new DirectLight((new Vector(0,0,0)),(new RGBColor(0,0,0)));};let PointLight=function(position,color,on){this.position=position.copy();this.color=color.copy();this.on=on!==undefined?on:true;};PointLight.prototype={getPosition:function(){return this.position.copy();},setPosition:function(position){this.position=position.copy();},getColor:function(){return this.color.copy();},setColor:function(color){this.color=color.copy();},setOn:function(on){this.on=on!==undefined?on:true;},getOn:function(){return this.on;},copy:function(){return new PointLight(this.position.copy(),this.color.copy());},};PointLight.neutral=function(){return new PointLight((new Vector(0,0,0)),(new RGBColor(0,0,0)));};let SpecularLight=function(power){this.power=power;};SpecularLight.prototype={getPower:function(){return this.power;},copy:function(){return new SpecularLight(this.power);},};SpecularLight.neutral=function(){return new SpecularLight(-1);};let Camera=function(eye,front,up){this.eye=eye.copy();this.front=front.unit();this.front.w=0;this.up=up.unit();this.up.w=0;};Camera.prototype={getEye:function(){return this.eye.copy();},setEye:function(eye){this.eye=eye.copy();},getAt:function(){return this.eye.add(this.front);},setAt:function(at){this.front=at.sub(this.eye).unit();},getFront:function(){return this.front.copy();},setFront:function(front){this.front=front.unit();this.front.w=0;},getUp:function(){return this.up.copy();},setUp:function(up){this.up=up.unit();this.up.w=0;},moveForward:function(distance){this.eye=this.eye.add(this.front.scale(distance));},moveBackward:function(distance){this.eye=this.eye.sub(this.front.scale(distance));},moveRight:function(distance){let right=this.front.cross(this.up);this.eye=this.eye.add(right.scale(distance));},moveLeft:function(distance){let right=this.front.cross(this.up);this.eye=this.eye.sub(right.scale(distance));},moveUp:function(distance){this.eye=this.eye.add(this.up.scale(distance));},moveDown:function(distance){this.eye=this.eye.sub(this.up.scale(distance));},yaw:function(radians){this.setFront(this.up.rotate(this.front,radians));},roll:function(radians){this.setUp(this.front.rotate(this.up,radians));},getView:function(){return Matrix.lookAt({eye:this.getEye(),at:this.getAt(),up:this.getUp()});},};let PolylineList=function(color){this.count=0;this.data=[];this.current=new Polyline(color);};PolylineList.prototype={insert:function(polyline){let i=0;for(;i<this.data.length;i++){if(this.data[i]===undefined)
break;}
this.data[i]=polyline;this.count+=1;return i;},makeNew:function(color){let i=this.insert(this.current);this.current=new Polyline(color);return i;},at:function(i){return this.data[i];},map:function(cb){for(let i=0;i<this.data.length;i++)
if(this.data[i]!==undefined)
cb(i,this.data[i]);},remove:function(i){this.data[i]=undefined;this.count-=1;},};let ModelList=function(insertCallBack){this.count=0;this.data=[];this.insertCallBack=insertCallBack!==undefined?insertCallBack:((i,model)=>i);};ModelList.prototype={insert:function(model){let i=0;for(;i<this.data.length;i++){if(this.data[i]===undefined)
break;}
this.data[i]=model;this.count+=1;return this.insertCallBack(i,this.data[i]);},at:function(i){return this.data[i];},map:function(callBack){for(let i=0;i<this.data.length;i++){if(this.data[i]!==undefined)
callBack(i,this.data[i]);}},mapVisible:function(callBack){for(let i=0;i<this.data.length;i++){if(this.data[i]!==undefined&&this.data[i].visible())
callBack(i,this.data[i]);}},remove:function(i){this.data[i]=undefined;this.count-=1;},};let WHITE=null;let BLACK=null;let RED=null;let GREEN=null;let BLUE=null;let GREY=null;let DARK_GREY=null;let LIGHT_GREY=null;let CANVAS=null;let WIDTH=null;let HEIGHT=null;let DEPTH=250;let COLOR=null;let ROTATE_X=0;let ROTATE_Y=0;let ROTATE_Z=0;let TRANSLATE_X=0;let TRANSLATE_Y=0;let TRANSLATE_Z=0;let MODELS=null;let SELECTED=null;let FOCUSED=null;let CAMERA;{let EYE=new Vector(0,0,350);let FRONT=(new Vector(0,0,0)).sub(EYE);let UP=new Vector(0,1,0);CAMERA=new Camera(EYE,FRONT,UP);}
let AMBIANT_COLOR=(new RGBColor(1,1,1)).scale(0.15);let DIRECT_X=0;let DIRECT_Y=-100;let DIRECT_Z=-100;let DIRECT_COLOR=(new RGBColor(1,1,1)).scale(0.8);let POINT_X=250;let POINT_Y=150;let POINT_Z=250;let POINT_COLOR=(new RGBColor(1,1,1)).scale(0.8);let SPECULAR_POWER=12;let TABS=[];let TAB_COUNTER=0;let light={AMBIANT:'light-ambiant',DIRECT:'light-direct',POINT:'light-point',SPECULAR:'light-specular'};let LIGHT={ambiant:true,direct:false,point:true,specular:true};let PERSPECTIVE_FOVY=60;let projection={ORTHOGRAPHIC:'projection-orthographic',PERSPECTIVE:'projection-perspective'};let PROJECTION=projection.PERSPECTIVE;let shading={FLAT:'shading-flat',GOURAUD:'shading-gouraud',PHONG:'shading-phong',NORMAL:'shading-normal',DEPTH:'shading-depth',EDGE:'shading-edge',EDGE_SELECTION:'shading-edge-selection',RED_CYAN:'shading-red-cyan'};let SHADING=shading.PHONG;let shape={CYLINDER:'shape-cylinder',SPHERE:'shape-sphere'};let SHAPE=shape.SPHERE;let KEYS={y:89,u:85,g:71,h:72,i:73,o:79,j:74,k:75,LEFT:37,RIGHT:39,UP:38,DOWN:40};function init(){WHITE=RGBColor.fromHex($('#g-colors').css('--white'));BLACK=RGBColor.fromHex($('#g-colors').css('--black'));RED=RGBColor.fromHex($('#g-colors').css('--red'));GREEN=RGBColor.fromHex($('#g-colors').css('--green'));BLUE=RGBColor.fromHex($('#g-colors').css('--blue'));GREY=RGBColor.fromHex($('#g-colors').css('--grey'));DARK_GREY=RGBColor.fromHex($('#g-colors').css('--dark-grey'));LIGHT_GREY=RGBColor.fromHex($('#g-colors').css('--light-grey'));WIDTH=$('#g-webgl').css('width');HEIGHT=$('#g-webgl').css('height');COLOR=RGBColor.fromHex($('#g-webgl').css('--background-color'));CANVAS=$('#webgl');CANVAS.attr('width',WIDTH);CANVAS.attr('height',HEIGHT);$('span.spacer').each(function(i,elem){let e=$(elem);e.css('width',e.attr('data-size')||e.css('--size'));});$('.tab-labels').each(function(i,elem){let e=$(elem);let id=TAB_COUNTER++;e.attr('data-id',id);TABS[id]=[];let def=e.attr('data-default')||e.children('label').first().attr('for');set_current_tab(elem,def);e.children('label').each(function(i,elem){if($(elem).attr('data-disabled')!=='disabled')
TABS[id].push(`label[for=${$(elem).attr('for')}]`);});enable_tabs(e);});setupIOSOR('file-picker');}
function enable_tabs(e){if(e===undefined){$('.tab-labels').each((i,elem)=>enable_tabs(elem));return;}
e=$(e);let id=e.attr('data-id');TABS[id].map(function(elem){$(elem).removeAttr('data-disabled');});e.children('label').each(function(i,elem){let label_for=$(elem).attr('for');$(elem).click(function(ev){if($(ev.target).attr('data-disabled')!=='disabled')
set_current_tab(e,label_for)});});}
function disable_tabs(e){if(e===undefined){$('.tab-labels').each((i,elem)=>disable_tabs(elem));return;}
e=$(e);let id=e.attr('data-id');TABS[id].map(function(elem){$(elem).attr('data-disabled','disabled');});e.children('label').each(function(i,elem){$(elem).off('click');});}
function set_current_tab(tabs_elem,label_for){$(tabs_elem).children('label').each(function(i,elem){let e=$(elem);if(e.attr('for')!==label_for)
e.removeClass('current');else
e.addClass('current');});$(tabs_elem).nextAll('.tab').each(function(i,elem){let e=$(elem);if(e.attr('id')!==label_for)
e.prop('hidden',true);else
e.prop('hidden',false);});}
function begin_animation(buttonID){disable_tabs();$('#animation button').each(function(i,elem){if(buttonID!==undefined){if($(elem).attr('id')===buttonID)
$(elem).addClass('running');else
$(elem).prop('disabled',true);}else{$(elem).prop('disabled',true);}});}
function end_animation(buttonID){$('#animation button').each(function(i,elem){if(buttonID!==undefined){if($(elem).attr('id')===buttonID)
$(elem).removeClass('running');else
$(elem).prop('disabled',false);}else{$(elem).prop('disabled',false);}});enable_tabs();}
function do_animation(callback){begin_animation();callback();end_animation();}
function main(){init();let gl=getWebGLContext(CANVAS[0]);if(!gl){console.log('Failed to get the rendering context for WebGL');return;}
start(gl);}
function start(gl){gl.enable(gl.DEPTH_TEST);let width=parseInt(WIDTH);let height=parseInt(HEIGHT);MODELS=new ModelList(function(i,model){$('div#model-pane').append(`
            <div id="model-${i}" class="item">
                <label>${i}:</label>
                <input id="model-select-${i}" name="models" class="select" type="radio" />
                <label for="model-select-${i}">${model.getName()}</label>
                <input id="model-hide-${i}" name="models" type="checkbox" />
                <label for="model-hide-${i}"><i class="fas fa-eye-slash"></i></label>
                <button class="remove"><i class="fas fa-times"></i></button>
            </div>
        `);let selector=$(`#model-select-${i}`);selector.on('change',function(e){if($(e.target).prop('checked'))
select_model(gl,i);});selector.prop('checked',true).change();$(`#model-hide-${i}`).on('change',function(e){MODELS.at(i).visible(!$(e.target).prop('checked'));render(gl);});let controls=$(`div#model-${i}`);controls.children('.remove').click(function(){if(SELECTED===i)
select_model(gl,null);controls.remove();MODELS.remove(i);render(gl);});});select_model(gl,null);{let sphere=(new Sphere((new Vector(0,0,0)),100)).toTriangles(50,50);let mySphere=new Model('My Sphere 1',sphere.indices,sphere.vertices,{color:new RGBColor(0.2,0.2,1.0)});MODELS.insert(mySphere);}
{let sphere=(new Sphere((new Vector(0,0,0)),40)).toTriangles(50,50);let mySphere=new Model('My Sphere 2',sphere.indices,sphere.vertices,{color:new RGBColor(0.2,1.0,0.2)});mySphere.setTranslateX(200);MODELS.insert(mySphere);}
CANVAS.mousedown(function(e){switch(e.which){case 1:let mouse=get_mouse_xy(CANVAS,e);let result=new Uint8Array(4);picking_render(gl);gl.readPixels(mouse.x,mouse.y,1,1,gl.RGBA,gl.UNSIGNED_BYTE,result);console.log('Alpha-picking pixel color:',result);let i=255-(result[3]+1);if(i<0){$('form#models input.select').prop('checked',false);select_model(gl,null);}else{$(`#model-select-${i}`).prop('checked',true).change();}
break;}});CANVAS.mousemove(function(e){let mouse=get_mouse_xy(CANVAS,e);let result=new Uint8Array(4);picking_render(gl);gl.readPixels(mouse.x,mouse.y,1,1,gl.RGBA,gl.UNSIGNED_BYTE,result);let i=255-(result[3]+1);if(i<0){FOCUSED=null;}else{FOCUSED=i;console.log('Focused model:',FOCUSED);}
render(gl);});$(document).on('keydown',function(e){if($(e.target).is('input'))
return;console.log('Received keypress:',event.which);switch(e.keyCode){case KEYS.y:CAMERA.yaw(Radians.fromDegrees(5));break;case KEYS.u:CAMERA.yaw(Radians.fromDegrees(-5));break;case KEYS.g:CAMERA.roll(Radians.fromDegrees(5));break;case KEYS.h:CAMERA.roll(Radians.fromDegrees(-5));break;case KEYS.i:PERSPECTIVE_FOVY-=5;console.log('Camera FOV-Y:',PERSPECTIVE_FOVY);break;case KEYS.o:PERSPECTIVE_FOVY+=5;console.log('Camera FOV-Y:',PERSPECTIVE_FOVY);break;case KEYS.j:CAMERA.moveForward(20);break;case KEYS.k:CAMERA.moveBackward(20);break;case KEYS.LEFT:CAMERA.moveLeft(10);break;case KEYS.RIGHT:CAMERA.moveRight(10);break;case KEYS.UP:CAMERA.moveUp(10);break;case KEYS.DOWN:CAMERA.moveDown(10);break;}
console.log('CAMERA.eye:',CAMERA.getEye());console.log('CAMERA.front:',CAMERA.getFront());console.log('CAMERA.up:',CAMERA.getUp());render(gl);});init_angle_slider(((value)=>value!==undefined?ROTATE_X=value:ROTATE_X),'rotate-world-x',(()=>render(gl)));init_angle_slider(((value)=>value!==undefined?ROTATE_Y=value:ROTATE_Y),'rotate-world-y',(()=>render(gl)));init_angle_slider(((value)=>value!==undefined?ROTATE_Z=value:ROTATE_Z),'rotate-world-z',(()=>render(gl)));init_space_slider(width,((value)=>value!==undefined?TRANSLATE_X=value:TRANSLATE_X),'translate-world-x',(()=>render(gl)));init_space_slider(height,((value)=>value!==undefined?TRANSLATE_Y=value:TRANSLATE_Y),'translate-world-y',(()=>render(gl)));init_space_slider(DEPTH,((value)=>value!==undefined?TRANSLATE_Z=value:TRANSLATE_Z),'translate-world-z',(()=>render(gl)));$('#'+PROJECTION).prop('checked',true);$('form#projection input[name=projection]').on('change',function(e){let elem=$(e.target);PROJECTION=elem.attr('id');render(gl);});init_color_picker(((value)=>value!==undefined?AMBIANT_COLOR=value:AMBIANT_COLOR),'light-ambiant-color',(()=>render(gl)));init_direc_slider(((value)=>value!==undefined?DIRECT_X=value:DIRECT_X),'light-direct-x',(()=>render(gl)));init_direc_slider(((value)=>value!==undefined?DIRECT_Y=value:DIRECT_Y),'light-direct-y',(()=>render(gl)));init_direc_slider(((value)=>value!==undefined?DIRECT_Z=value:DIRECT_Z),'light-direct-z',(()=>render(gl)));init_color_picker(((value)=>value!==undefined?DIRECT_COLOR=value:DIRECT_COLOR),'light-direct-color',(()=>render(gl)));init_space_slider(width,((value)=>value!==undefined?POINT_X=value:POINT_X),'light-point-x',(()=>render(gl)));init_space_slider(height,((value)=>value!==undefined?POINT_Y=value:POINT_Y),'light-point-y',(()=>render(gl)));init_space_slider(DEPTH,((value)=>value!==undefined?POINT_Z=value:POINT_Z),'light-point-z',(()=>render(gl)));init_color_picker(((value)=>value!==undefined?POINT_COLOR=value:POINT_COLOR),'light-point-color',(()=>render(gl)));$('#'+light.AMBIANT).prop('checked',LIGHT.ambiant);$('#'+light.AMBIANT).on('change',function(e){LIGHT.ambiant=$(e.target).prop('checked');render(gl);});$('#'+light.DIRECT).prop('checked',LIGHT.direct);$('#'+light.DIRECT).on('change',function(e){LIGHT.direct=$(e.target).prop('checked');render(gl);});$('#'+light.POINT).prop('checked',LIGHT.point);$('#'+light.POINT).on('change',function(e){LIGHT.point=$(e.target).prop('checked');render(gl);});init_range({id:'light-specular-power',value:SPECULAR_POWER,min:2,max:128,step:2,parse:function(value){SPECULAR_POWER=parseInt(value);value=SPECULAR_POWER.toString();switch(value.length){case 1:value='00'+value;break;case 2:value='0'+value;break;}
return value;},update:function(){render(gl);}});$('#'+light.SPECULAR).prop('checked',LIGHT.specular);$('#'+light.SPECULAR).on('change',function(e){LIGHT.specular=$(e.target).prop('checked');render(gl);});$('#'+SHADING).prop('checked',true);$('form#shading-type input[name=shading-type]').on('change',function(e){let elem=$(e.target);SHADING=elem.attr('id');render(gl);});$('#'+SHAPE).prop('checked',true);$('form#shape-type input[name=shape-type]').on('change',function(e){let elem=$(e.target);SHAPE=elem.attr('id');render(gl);});$('#animate-rotate-about').click(function(){begin_animation('animate-rotate-about');setTimeout(function(){console.log('Animating...');end_animation('animate-rotate-about');},2000);});$('#animate-shake').click(function(){begin_animation('animate-shake');setTimeout(function(){console.log('Animating...');end_animation('animate-shake');},2000);});$('#animate-stretch').click(function(){begin_animation('animate-stretch');setTimeout(function(){console.log('Animating...');end_animation('animate-stretch');},2000);});render(gl);}
function select_model(gl,i){const SCALE=5;if(i<0)
i=null;SELECTED=i;console.log('Selected model:',SELECTED);let width=parseInt(WIDTH);let height=parseInt(HEIGHT);if(i===null){init_angle_slider((()=>0),'rotate-model-x',(()=>undefined));init_angle_slider((()=>0),'rotate-model-y',(()=>undefined));init_angle_slider((()=>0),'rotate-model-z',(()=>undefined));init_space_slider(width,(()=>0),'translate-model-x',(()=>undefined));init_space_slider(height,(()=>0),'translate-model-y',(()=>undefined));init_space_slider(DEPTH,(()=>0),'translate-model-z',(()=>undefined));init_scale_slider(SCALE,(()=>1),'scale-model-x',(()=>undefined));init_scale_slider(SCALE,(()=>1),'scale-model-y',(()=>undefined));init_scale_slider(SCALE,(()=>1),'scale-model-z',(()=>undefined));$('div#editor input[type=range]').prop('disabled',true);}else{let model_space_slider=function(delta,getterName,setterName,sliderID){init_space_slider(delta,function(value){let model=MODELS.at(i);if(value!==undefined){model[setterName](value);}else{return model[getterName]();}},sliderID,(()=>render(gl)));};let model_scale_slider=function(getterName,setterName,sliderID){init_scale_slider(SCALE,function(value){let model=MODELS.at(i);if(value!==undefined){model[setterName](value);}else{return model[getterName]();}},sliderID,(()=>render(gl)));};model_space_slider(width,'getTranslateX','setTranslateX','translate-model-x');model_space_slider(height,'getTranslateY','setTranslateY','translate-model-y');model_space_slider(DEPTH,'getTranslateZ','setTranslateZ','translate-model-z');model_scale_slider('getScaleX','setScaleX','scale-model-x');model_scale_slider('getScaleY','setScaleY','scale-model-y');model_scale_slider('getScaleZ','setScaleZ','scale-model-z');}
render(gl);}
function init_angle_slider(var_fn,range_id,render_fn){init_range({id:range_id,value:var_fn(),min:-180,max:180,step:10,parse:function(value){var_fn(parseInt(value));value=Math.abs(var_fn()).toString();switch(value.length){case 1:value='00'+value;break;case 2:value='0'+value;break;}
if(var_fn()>=0)
value='+'+value;else
value='-'+value;return value;},update:function(){render_fn();}});}
function init_space_slider(delta,var_fn,range_id,render_fn){init_range({id:range_id,value:var_fn(),min:-delta,max:delta,step:5,parse:function(value){var_fn(parseInt(value));value=Math.abs(var_fn()).toString();switch(value.length){case 1:value='00'+value;break;case 2:value='0'+value;break;}
if(var_fn()>=0)
value='+'+value;else
value='-'+value;return value;},update:function(){render_fn();}});}
function init_scale_slider(delta,var_fn,range_id,render_fn){init_range({id:range_id,value:var_fn(),min:0,max:delta,step:0.05,parse:function(value){var_fn(parseFloat(value));return Math.abs(var_fn()).toFixed(2);},update:function(){render_fn();}});}
function init_direc_slider(var_fn,range_id,render_fn){init_range({id:range_id,value:var_fn(),min:-100,max:100,step:1,parse:function(value){var_fn(parseInt(value));value=Math.abs(var_fn()).toString();switch(value.length){case 1:value='00'+value;break;case 2:value='0'+value;break;}
if(var_fn()>=0)
value='+'+value;else
value='-'+value;return value;},update:function(){render_fn();}});}
function render(gl){clear(gl,COLOR);let world=new Matrix();world=world.rotateX(Radians.fromDegrees(ROTATE_X));world=world.rotateY(Radians.fromDegrees(ROTATE_Y));world=world.rotateZ(Radians.fromDegrees(ROTATE_Z));{let vec=new Vector(TRANSLATE_X,TRANSLATE_Y,TRANSLATE_Z);world=world.translate(vec);}
let view=CAMERA.getView();let width=parseInt(WIDTH);let height=parseInt(HEIGHT);let proj;switch(PROJECTION){case projection.ORTHOGRAPHIC:proj=Matrix.ortho({left:-(width/2),right:width/2,bottom:-(height/2),top:height/2,near:1,far:1000});break;case projection.PERSPECTIVE:proj=Matrix.perspective({fovy:Radians.fromDegrees(PERSPECTIVE_FOVY),aspect:width/height,near:1,far:1000});break;}
let lights={};if(LIGHT.ambiant)
lights.ambiant=new AmbiantLight(AMBIANT_COLOR);else
lights.ambiant=null;if(LIGHT.direct)
lights.direct=new DirectLight(new Vector(DIRECT_X,DIRECT_Y,DIRECT_Z),DIRECT_COLOR);else
lights.direct=null;lights.point=new PointLight(new Vector(POINT_X,POINT_Y,POINT_Z),POINT_COLOR);if(!LIGHT.point)
lights.point.setOn(false);if(LIGHT.specular)
lights.specular=new SpecularLight(SPECULAR_POWER);else
lights.specular=null;MODELS.mapVisible(function(i,model){let color=model.getColor();switch(SHADING){case shading.FLAT:render_flat(gl,model,color,world,CAMERA,proj,lights);break;case shading.GOURAUD:render_gouraud(gl,model,color,world,CAMERA,proj,lights);break;case shading.PHONG:render_phong(gl,model,color,world,CAMERA,proj,lights);break;case shading.NORMAL:render_normal(gl,model,world,view,proj);break;case shading.DEPTH:render_depth(gl,model,color,world,view,proj,250,50);break;case shading.EDGE:render_edge(gl,model,(new RGBColor(0,0,0)),color,1/2,world,view,proj);break;case shading.EDGE_SELECTION:render_edge_selection(gl,i,model,color,world,view,proj);break;}});}
function render_edge_selection(gl,i,model,color,world,view,projection){color=color.scale(0.5);let selectedColor=WHITE.scale(0.8);let focusedColor=selectedColor.scale(0.8);if(i===SELECTED){render_edge(gl,model,color,selectedColor,1/2,world,view,projection);}else if(i===FOCUSED){render_edge(gl,model,color,focusedColor,1/8,world,view,projection);}else{render_edge(gl,model,color,(new RGBColor(0,0,0)),0,world,view,projection);}}
function picking_render(gl){clear(gl,(new RGBColor(0,0,0)));let world=new Matrix();world=world.rotateX(Radians.fromDegrees(ROTATE_X));world=world.rotateY(Radians.fromDegrees(ROTATE_Y));world=world.rotateZ(Radians.fromDegrees(ROTATE_Z));{let vec=new Vector(TRANSLATE_X,TRANSLATE_Y,TRANSLATE_Z);world=world.translate(vec);}
let view=CAMERA.getView();let width=parseInt(WIDTH);let height=parseInt(HEIGHT);let proj;switch(PROJECTION){case projection.ORTHOGRAPHIC:proj=Matrix.ortho({left:-(width/2),right:width/2,bottom:-(height/2),top:height/2,near:1,far:1000});break;case projection.PERSPECTIVE:proj=Matrix.perspective({fovy:Radians.fromDegrees(PERSPECTIVE_FOVY),aspect:width/height,near:1,far:1000});break;}
let lights={ambiant:null,direct:null,point:null,specular:null};MODELS.mapVisible(function(i,model){let color=(new RGBColor(0,0,0)).copy().setAlpha((255-(i+1))/255);render_flat(gl,model,color,world,CAMERA,proj,lights);});}